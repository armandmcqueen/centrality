# AUTOGENERATED FILE DO NOT EDIT

from typing import cast

from sqlalchemy import Index
from sqlalchemy.dialects.postgresql import JSONB
from sqlalchemy.orm import Mapped, mapped_column
from controlplane.datastore.types.vmmetrics.metric import (
    MetricBaseORM,
    MetricLatestBaseORM,
    MetricBaseModel,
    MetricLatestBaseModel,
)
from pydantic import BaseModel


metric_name = "gpu_memory"
# example gpu_memory metrics: [[used, total], [used, total]]
metric_shape_db = list[list[float]]


# Custom Types
class GpuMemory(BaseModel):
    used_mb: float
    total_mb: float


# Convert metrics column in DB to object fields as dict that can be passed to super().from_orm() as kwargs
def convert(metrics: list[list[float]]) -> dict[str, list[GpuMemory]]:
    memory = [
        GpuMemory(used_mb=memory_vals[0], total_mb=memory_vals[1])
        for memory_vals in metrics
    ]

    return dict(memory=memory)


class GpuMemoryMetricLatestORM(MetricLatestBaseORM):
    __tablename__ = "machine_metric_gpu_memory_latest"
    metrics: Mapped[list[list[float]]] = mapped_column(JSONB, nullable=False)


class GpuMemoryMetricORM(MetricBaseORM):
    __tablename__ = "machine_metric_gpu_memory"
    metrics: Mapped[list[list[float]]] = mapped_column(JSONB, nullable=False)

    __table_args__ = (
        Index("idx_metric_gpu_memory_ts", "ts"),  # Creating the index
        Index("idx_metric_gpu_memory_vm_id_ts", "vm_id", "ts"),  # Composite index
    )


class GpuMemoryMetricLatest(MetricLatestBaseModel):
    memory: list[GpuMemory]

    @classmethod
    def from_orm(
        cls, orm: GpuMemoryMetricLatestORM, **kwargs
    ) -> "GpuMemoryMetricLatest":
        instance = super().from_orm(orm=orm, **convert(orm.metrics))
        return cast(GpuMemoryMetricLatest, instance)


class GpuMemoryMetric(MetricBaseModel):
    memory: list[GpuMemory]

    @classmethod
    def from_orm(cls, orm: GpuMemoryMetricORM, **kwargs) -> "GpuMemoryMetric":
        instance = super().from_orm(orm=orm, **convert(orm.metrics))
        return cast(GpuMemoryMetric, instance)
