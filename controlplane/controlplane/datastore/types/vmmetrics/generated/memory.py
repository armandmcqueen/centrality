# AUTOGENERATED FILE DO NOT EDIT

from typing import cast, Any
import datetime
from sqlalchemy import Index
from sqlalchemy.dialects.postgresql import JSONB
from sqlalchemy.orm import Mapped, mapped_column
from controlplane.datastore.types.vmmetrics.metric import (
    MetricBaseORM,
    MetricLatestBaseORM,
    MetricBaseModel,
    MetricLatestBaseModel,
)
from pydantic import BaseModel


metric_name = "memory"
# example memory metrics: [1000, 2000]
metric_shape_db = list[float]


# Custom Types


# Convert metrics column in DB to object fields as dict that can be passed to super().from_orm() as kwargs
def convert_from_metrics(metrics: list[float]) -> dict[str, float]:
    free_memory_mb = metrics[0]
    total_memory_mb = metrics[1]
    return dict(free_memory_mb=free_memory_mb, total_memory_mb=total_memory_mb)


# Convert user-facing object fields to metrics column shape in DB
def convert_to_metrics(self: Any) -> list[float]:
    return [self.free_memory_mb, self.total_memory_mb]


class MemoryMetricLatestORM(MetricLatestBaseORM):
    __tablename__ = "machine_metric_memory_latest"
    metrics: Mapped[list[float]] = mapped_column(JSONB, nullable=False)


class MemoryMetricORM(MetricBaseORM):
    __tablename__ = "machine_metric_memory"
    metrics: Mapped[list[float]] = mapped_column(JSONB, nullable=False)

    __table_args__ = (
        Index("idx_metric_memory_ts", "ts"),  # Creating the index
        Index("idx_metric_memory_vm_id_ts", "vm_id", "ts"),  # Composite index
    )


class MemoryMetricLatest(MetricLatestBaseModel):
    vm_id: str
    ts: datetime.datetime
    free_memory_mb: float
    total_memory_mb: float

    @classmethod
    def from_orm(cls, orm: MemoryMetricLatestORM, **kwargs) -> "MemoryMetricLatest":
        instance = super().from_orm(orm=orm, **convert_from_metrics(orm.metrics))
        return cast(MemoryMetricLatest, instance)

    def to_memory_measurement(self) -> "MemoryMeasurement":
        kwargs = self.model_dump()
        return MemoryMeasurement(**kwargs)


class MemoryMetric(MetricBaseModel):
    metric_id: str
    vm_id: str
    ts: datetime.datetime
    free_memory_mb: float
    total_memory_mb: float

    @classmethod
    def from_orm(cls, orm: MemoryMetricORM, **kwargs) -> "MemoryMetric":
        instance = super().from_orm(orm=orm, **convert_from_metrics(orm.metrics))
        return cast(MemoryMetric, instance)

    def to_memory_measurement(self) -> "MemoryMeasurement":
        kwargs = self.model_dump()
        kwargs.pop("metric_id")
        return MemoryMeasurement(**kwargs)


class MemoryMeasurement(BaseModel):
    """
    A measurement of Memory
    """

    # This is the user-facing object that is sent to and from the REST endpoint
    vm_id: str
    ts: datetime.datetime
    free_memory_mb: float
    total_memory_mb: float

    def to_metrics(self) -> list[float]:
        return convert_to_metrics(self)
